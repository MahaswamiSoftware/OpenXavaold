<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>openxava - testing_es</title>
    <link rel="stylesheet" href="static/style.css" type="text/css">
    <link rel="stylesheet" href="highlight/highlight.css">
    <script src="highlight/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div class="wiki" id="content_view" style="display: block;">
      <div id="toc">
        <h1 class="nopad">Table of Contents</h1>
        <div style="margin-left: 1em;"><a href="#Leccion+3:+Pruebas+automaticas">Lección

            3: Pruebas automáticas</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-JUnit">JUnit</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos">ModuleTestBase
            para probar módulos</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos-El+codigo+para+la+prueba">El
            código para la prueba</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos-Ejecutar+las+pruebas+desde+Eclipse">Ejecutar
            las pruebas desde Eclipse</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA">Crear
            datos de prueba usando JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Los+metodos+setUp%28%29+y+tearDown%28%29">Los
            métodos setUp() y tearDown()</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Crear+datos+con+JPA">Crear
            datos con JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Borrar+datos+con+JPA">Borrar
            datos con JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Filtrar+datos+desde+modo+lista+en+una+prueba">Filtrar
            datos desde modo lista en una prueba</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Usar+instancias+de+entidad+dentro+de+una+prueba">Usar
            instancias de entidad dentro de una prueba</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-Usar+datos+ya+existentes+para+probar">Usar
            datos ya existentes para probar</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-Probar+colecciones">Probar
            colecciones</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Probar+colecciones-Dividir+la+prueba+en+varios+metodos">Dividir
            la prueba en varios métodos</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Probar+colecciones-Verificar+valores+por+defecto">Verificar
            valores por defecto</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Probar+colecciones-Entrada+de+datos">Entrada
            de datos</a></div>
        <div style="margin-left: 3em;"><a href="#Leccion+3:+Pruebas+automaticas-Probar+colecciones-Verificar+los+datos">Verificar
            los datos</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-Suite">Suite</a></div>
        <div style="margin-left: 2em;"><a href="#Leccion+3:+Pruebas+automaticas-Resumen">Resumen</a></div>
      </div>
      <strong>Curso</strong>: <a class="wiki_link" href="getting-started_es.html">1.
        Primeros pasos</a> | <a class="wiki_link" href="modeling_es.html">2.
        Modelar con Java</a> | <strong>3. Pruebas automáticas</strong> | <a class="wiki_link"
        href="inheritance_es.html">4. Herencia</a> | <a class="wiki_link" href="basic-business-logic_es.html">5.
        Lógica de negocio básica</a> | <a class="wiki_link" href="validation_es.html">6.
        Validación avanzada</a> | <a class="wiki_link" href="refining-standard-behavior_es.html">7.
        Refinar el comportamiento predefinido</a> | <a class="wiki_link" href="business-logic-behavior_es.html">8.
        Comportamiento y lógica de negocio</a> | <a class="wiki_link" href="references-collections_es.html">9.
        Referencias y colecciones</a> | <a class="wiki_link" href="philosophy_es.html">A.
        Arquitectura y filosofía</a> | <a class="wiki_link" href="jpa_es.html">B.
        Java Persistence API</a> | <a class="wiki_link" href="annotations_es.html">C.
        Anotaciones</a><br>
      <h1 id="toc0"><a name="Leccion+3:+Pruebas+automaticas"></a>Lección 3:
        Pruebas automáticas</h1>
      Las pruebas son la parte más importante del desarrollo de software. No
      importa cuan bonita, rápida o tecnológicamente avanzada sea tu aplicación,
      si falla, darás una impresión muy pobre.<br>
      Hacer pruebas manuales, es decir, abrir el navegador y ejecutar la
      aplicación exactamente como lo haría un usuario final, no es viable;
      porque el problema real no está en el código que acabas de escribir, sino
      en el código que ya estaba ahí. Normalmente pruebas el código que acabas
      de escribir, pero no pruebas todo el código que ya existe en tu
      aplicación. Y sabes muy bien que cuando tocas cualquier parte de tu
      aplicación puedes romper cualquier otra parte inadvertidamente.<br>
      Necesitas poder hacer cualquier cambio en tu código con la tranquilidad de
      que no vas a romper tu aplicación. Una forma de conseguirlo, es usando
      pruebas automáticas. Vamos a hacer pruebas automáticas usando JUnit.<br>
      <h2 id="toc1"><a name="Leccion+3:+Pruebas+automaticas-JUnit"></a>JUnit</h2>
      JUnit es una herramienta muy popular para hacer pruebas automáticas. Esta
      herramienta está integrada con Eclipse, por tanto no necesitas descargarla
      para poder usarla. OpenXava extiende las capacidades de JUnit para
      permitir probar un módulo de OpenXava exactamente de la misma forma que lo
      haría un usuario final. De hecho, OpenXava usa HtmlUnit, un software que
      simula un navegador real (incluyendo JavaScript) desde Java. Todo está
      disponible desde la clase de OpenXava <em>ModuleTestBase</em>, que te
      permite automatizar las pruebas que tú harías a mano usando un navegador
      de verdad de una forma simple.<br>
      La mejor manera de entender como funcionan las pruebas en OpenXava es
      verlo en acción.<br>
      <h2 id="toc2"><a name="Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos"></a>ModuleTestBase
        para probar módulos</h2>
      Para crear una prueba para un módulo de OpenXava extendemos de la clase <em>ModuleTestBase</em>
      del paquete <em>org.openxava.tests</em>. Esta clase te permite conectar
      con un módulo OpenXava como un navegador real, y tiene muchos métodos
      útiles para probar tu módulo. Creemos la prueba para tu módulo <em>Cliente</em>.<br>
      <h3 id="toc3"><a name="Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos-El+codigo+para+la+prueba"></a>El
        código para la prueba</h3>
      Crea un paquete nuevo llamado <em>com.tuempresa.facturacion.pruebas</em> y
      dentro de él una nueva clase llamada <em>PruebaCliente</em> con el
      siguiente código:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.tuempresa.facturacion.pruebas;
 
import org.openxava.tests.*;
 
public class PruebaCliente extends ModuleTestBase { // Ha de extender de ModuleTestBase
 
    public PruebaCliente(String nombrePrueba) {
        super(nombrePrueba, "Facturacion", // Indicamos el nombre de aplicación (Facturacion)
                "Cliente"); // y nombre de módulo (Cliente)
    }
 
    // Los métodos de prueba han de empezar por 'test'
    public void testCrearLeerActualizarBorrar() throws Exception {
        login("admin", "admin"); // Identificación de usuario para acceder al módulo
 
        // Crear
        execute("CRUD.new"); // Pulsa el botón 'Nuevo'
        setValue("numero", "77"); // Teclea 77 como valor para el campo 'numero'
        setValue("nombre", "Cliente JUNIT"); // Pone valor en el campo 'nombre'
        setValue("direccion.viaPublica", "Calle JUNIT"); // Fíjate en la notación del punto
                                                // para acceder al miembro de la referencia
        setValue("direccion.codigoPostal", "77555"); // Etc
        setValue("direccion.municipio", "La ciudad JUNIT"); // Etc
        setValue("direccion.provincia", "La provincia JUNIT"); // Etc
        execute("CRUD.save"); // Pulsa el botón 'Grabar'
        assertNoErrors(); // Verifica que la aplicación no muestra errores
        assertValue("numero", ""); // Verifica que el campo 'numero' está vacío
        assertValue("nombre", ""); // Verifica que el campo 'nombre' está vacío
        assertValue("direccion.viaPublica", ""); // Etc
        assertValue("direccion.codigoPostal", ""); // Etc
        assertValue("direccion.municipio", ""); // Etc
        assertValue("direccion.provincia", ""); // Etc
 
        // Leer
        setValue("numero", "77"); // Pone 77 como valor para el campo 'numero'
        execute("CRUD.refresh"); // Pulsa el botón 'Refrescar'
        assertValue("numero", "77"); // Verifica que el campo 'numero' tiene un 77
        assertValue("nombre", "Cliente JUNIT"); // y 'nombre' tiene 'Cliente JUNIT'
        assertValue("direccion.viaPublica", "Calle JUNIT"); // Etc
        assertValue("direccion.codigoPostal", "77555"); // Etc
        assertValue("direccion.municipio", "La ciudad JUNIT"); // Etc
        assertValue("direccion.provincia", "La provincia JUNIT"); // Etc
 
        // Actualizar
        setValue("nombre", "Cliente JUNIT MODIFICADO"); // Cambia el valor del campo 'nombre'
        execute("CRUD.save"); // Pulsa el botón 'Grabar'
        assertNoErrors(); // Verifica que la aplicación no muestra errores
        assertValue("numero", ""); // Verifica que el campo 'numero' está vacío
        assertValue("nombre", ""); // Verifica que el campo 'nombre' está vacío
 
        // Verifica si se ha modificado
        setValue("numero", "77"); // Pone 77 como valor para el campo 'numero'
        execute("CRUD.refresh"); // Pulsa en el botón 'Refrescar'
        assertValue("numero", "77"); // Verifica que el campo 'numero' tiene un 77
        assertValue("nombre", "Cliente JUNIT MODIFICADO"); // y 'nombre' tiene
                                                        // 'Cliente JUNIT MODIFICADO'
        // Borrar
        execute("CRUD.delete"); // Pulsa en el botón 'Borrar'
        assertMessage("Cliente borrado satisfactoriamente"); // Verifica que el mensaje
                                // 'Cliente borrado satisfactoriamente' se muestra al usuario
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Esta prueba crea un nuevo cliente,
      lo busca, lo modifica y al final lo borra. Aquí ves como puedes usar
      métodos como <em>execute()</em> o <em>setValue()</em> para simular las
      acciones del usuario, y métodos como <em>assertValue()</em>, <em>assertNoErrors()</em>
      o <em>assertMessage()</em> para verificar el estado de la interfaz de
      usuario. Tu prueba actúa como las manos y los ojos del usuario:<br>
      <img src="files/testing_es010.png" alt="testing_es010.png" title="testing_es010.png"><br>
      En <em>execute()</em> tienes que especificar el nombre calificado de la
      acción, esto quiere decir <em>NombreControlador.nombreAccion</em>. ¿Cómo
      puedes saber el nombre de la acción? Pasea tu ratón sobre el vínculo de la
      acción, y verás en la barra inferior de tu navegador un código JavaScript
      que incluye el nombre calificado de la acción:<br>
      <img src="files/testing_es020.png" alt="testing_es020.png" title="testing_es020.png"><br>
      Ahora ya sabes como crear una prueba para probar las operaciones de
      mantenimiento básicas de un módulo. No es necesario escribir una prueba
      demasiado exhaustiva al principio. Simplemente prueba las cosas básicas,
      aquellas cosas que normalmente probarías con un navegador. Tu prueba
      crecerá de forma natural a medida que tu aplicación crezca y los usuarios
      vayan encontrando fallos.<br>
      Aprendamos como ejecutar tu prueba desde Eclipse.<br>
      <h3 id="toc4"><a name="Leccion+3:+Pruebas+automaticas-ModuleTestBase+para+probar+modulos-Ejecutar+las+pruebas+desde+Eclipse"></a>Ejecutar
        las pruebas desde Eclipse</h3>
      JUnit está integrado dentro de Eclipse, por eso ejecutar tus prueba en
      Eclipse es más fácil que quitarle un caramelo a un niño. Pon el ratón
      sobre tu clase de prueba, y con el botón derecho escoge <em>Run As &gt;
        JUnit Test</em>:<br>
      <img src="files/testing_es030.png" alt="testing_es030.png" title="testing_es030.png"
        style="height: 285px; width: 800px;"><br>
      Si la prueba no es satisfactoria la barra sale roja. Puedes probarlo.
      Edita <em>PruebaCliente</em> y comenta la línea que da valor al campo <em>nombre</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">...
setValue("numero", "77");
// setValue("name", "Cliente JUNIT"); // Comenta esta línea
setValue("address.street", "Calle JUNIT");
...
</code></pre> </div>
    <div class="wiki" style="display: block;">Ahora, reejecuta la prueba. Ya que
      <em>nombre</em> es una propiedad requerida, un mensaje de error será
      mostrado al usuario, y el objeto no se grabará:<br>
      <img src="files/testing_es040.png" alt="testing_es040.png" title="testing_es040.png"><br>
      El assert culpable es <em>assertNoErrors()</em>, el cual además de fallar
      muestra en la consola los errores mostrados al usuario. Por eso, en la
      consola de ejecución de tu prueba verás un mensaje como este:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="plaintext">16-jul-2019 18:03 org.openxava.tests.ModuleTestBase assertNoMessages
SEVERE: Error unexpected: Es ogligado que Nombre en Cliente tenga valor
</code></pre> </div>
    <div class="wiki" style="display: block;">El problema es claro. El cliente
      no se ha grabado porque el nombre es obligatorio y éste no se ha
      especificado.<br>
      Has aprendido como se comporta la prueba cuando falla. Ahora, puedes
      descomentar la línea culpable y volver a ejecutar la prueba para verificar
      que todo sigue en su sitio.<br>
      <h2 id="toc5"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA"></a>Crear
        datos de prueba usando JPA</h2>
      En tu primera prueba, <em>PruebaCliente</em>, la prueba misma empieza
      creando los datos que van a ser usados en el resto de la prueba. Este es
      un buen enfoque, especialmente si quieres probar la entrada de datos
      también. Pero a veces te interesa probar solo un pequeño caso que falla, o
      simplemente tu módulo no permite entrada de datos. En cualquier caso
      puedes crear los datos que necesites para probar usando JPA desde tu
      prueba.<br>
      <h3 id="toc6"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Los+metodos+setUp()+y+tearDown()"></a>Los
        métodos setUp() y tearDown()</h3>
      Vamos a usar <em>PruebaProducto</em> para aprender como usar JPA para
      crear datos de prueba. Crearemos algunos productos antes de ejecutar cada
      prueba y los borraremos después. Veamos el código de <em>PruebaProducto</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.tuempresa.facturacion.pruebas;
 
import java.math.*;
import com.tuempresa.facturacion.modelo.*;
import org.openxava.tests.*;
import static org.openxava.jpa.XPersistence.*;
 
public class PruebaProducto extends ModuleTestBase {
 
    private Autor autor; // Declaramos las entidades a crear
    private Categoria categoria; // como miembros de instancia para que
    private Producto producto1; // estén disponibles en todos los métodos de prueba
    private Producto producto2; // y puedan ser borradas al final de cada prueba
 
    public PruebaProducto(String testName) {
        super(testName, "Facturacion", "Producto");
    }
 
    protected void setUp() throws Exception { // setUp() se ejecuta siempre antes de cada prueba
        super.setUp(); // Es necesario porque ModuleTestBase lo usa para inicializarse, JPA se inicializa aquí
        crearProductos(); // Crea los datos usados en las pruebas
    }
 
    protected void tearDown() throws Exception { // tearDown() se ejecuta
                                                 // siempre después de cada prueba
        super.tearDown(); // Necesario, ModuleTestBase cierra recursos aquí
        borrarProductos(); // Se borran los datos usados en las pruebas
    }
 
    public void testBorrarDesdeLista() throws Exception { ... }
 
    public void testCambiarPrecio() throws Exception { ... }
 
    private void crearProductos() { ... }
 
    private void borrarProductos() { ... }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Aquí estamos sobrescribiendo los
      métodos <em>setUp()</em> y <em>tearDown()</em>. Estos métodos son
      métodos de JUnit que son ejecutados justo antes y después de ejecutar cada
      método de prueba. Creamos los datos de prueba antes de ejecutar cada
      prueba, y borramos los datos después de cada prueba. Así, cada prueba
      puede contar con unos datos concretos para ejecutarse. No importa si otras
      pruebas borran o modifican datos, o el orden de ejecución de las pruebas.
      Siempre, al principio de cada método de prueba tenemos todos los datos
      listos para usar.<br>
      <h3 id="toc7"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Crear+datos+con+JPA"></a>Crear
        datos con JPA</h3>
      El método <em>crearProductos()</em> es el responsable de crear los datos
      de prueba usando JPA. Examinémoslo:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void crearProductos() {
    // Crear objetos Java
    autor = new Autor(); // Se crean objetos de Java convencionales
    autor.setNombre("JUNIT Author"); // Usamos setters como se suele hacer con Java
    categoria = new Categoria();
    categoria.setDescripcion("Categoria JUNIT");
    producto1 = new Producto();
    producto1.setNumero(900000001);
    producto1.setDescripcion("Producto JUNIT 1");
    producto1.setAutor(autor);
    producto1.setCategoria(categoria);
    producto1.setPrecio(new BigDecimal("10"));
    producto2 = new Producto();
    producto2.setNumero(900000002);
    producto2.setDescripcion("Producto JUNIT 2");
    producto2.setAutor(autor);
    producto2.setCategoria(categoria);
    producto2.setPrecio(new BigDecimal("20"));
 
    // Marcar los objetos como persistentes
    getManager().persist(autor); // getManager() es de XPersistence
    getManager().persist(categoria); // persist() marca el objeto como persistente
    getManager().persist(producto1); // para que se grabe en la base de datos
    getManager().persist(producto2);
 
    // Confirma los cambios en la base de datos
    commit(); // commit() es de XPersistence. Graba todos los objetos en la base de datos
              // y confirma la transacción
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Como puedes ver, primero creas los
      objetos al estilo convencional de Java. Fíjate que los asignamos a
      miembros de instancia, así puedes usarlos dentro de la prueba. Entonces,
      los marcas como persistentes, usando el método <em>persist()</em> del <em>EntityManager</em>
      de JPA. Para obtener el <em>PersistenceManager</em> solo has de escribir
      <em>getManager()</em> porque tienes un import estático arriba:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">import static org.openxava.jpa.XPersistence.*;
...
getManager().persist(autor);
    // Gracias al static import de XPersistence es lo mismo que
XPersistence.getManager().persist(autor);
...
commit();
    // Gracias al static import de XPersistence es lo mismo que
XPersistence.commit();
</code></pre> </div>
    <div class="wiki" style="display: block;">Para finalizar, <em>commit()</em>
      (también de <em>XPersistence</em>) graba todos los objetos a la base de
      datos y entonces confirma la transacción. Después de eso, los datos ya
      están en la base de datos listos para ser usados por tu prueba.<br>
      <h3 id="toc8"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Borrar+datos+con+JPA"></a>Borrar
        datos con JPA</h3>
      Después de que se ejecute la prueba borraremos los datos de prueba para
      dejar la base de datos limpia. Esto se hace en el método <em>borrarProductos()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void borrarProductos() { // Llamado desde tearDown()
                                 // por tanto ejecutado después de cada prueba
    borrar(producto1, producto2, autor, categoria); // borrar() borra
    commit(); // Confirma los cambios en la base de datos, en este caso borrando datos
}
 
private void borrar(Object ... entidades) { // Usamos argumentos varargs
    for (Object entidad : entidades) { // Iteramos por todos los argumentos
        getManager().remove(getManager().merge(entidad)); // Borrar(1)
    }
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Es un simple bucle por todas las
      entidades usadas en la prueba, borrándolas. Para borrar una entidad con
      JPA has de usar el método <em>remove()</em>, aunque en este caso has de
      usar el método <em>merge()</em> también (1). Esto es porque no puedes
      borrar una entidad desasociada (<em>detached entity</em>). Al usar <em>commit()</em>
      en <em>crearProductos()</em> todas la entidades grabadas pasaron a ser
      entidades desasociadas, porque continúan siendo objetos Java válidos pero
      el contexto persistente (<em>persistent context</em>, la unión entre las
      entidades y la base de datos) se perdió en el <em>commit()</em>, por eso
      tienes que reasociarlas al nuevo contexto persistente. Este concepto es
      fácil de entender con el siguiente código:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">getManager().persist(autor); // autor está asociado al contexto persistente actual
commit(); // El contexto persistente actual se termina, y autor pasa a estar desasociado
 
getManager().remove(autor); // Falla porque autor está desasociado
 
autor = getManager().merge(autor); // Reasocia autor al contexto actual
getManager().remove(autor); // Funciona
</code></pre> </div>
    <div class="wiki" style="display: block;">A parte de este curioso detalle
      sobre el <em>merge()</em>, el código para borrar es bastante sencillo.<br>
      <h3 id="toc9"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Filtrar+datos+desde+modo+lista+en+una+prueba"></a>Filtrar
        datos desde modo lista en una prueba</h3>
      Ahora que ya sabes como crear y borrar datos para las pruebas, examinemos
      los métodos de prueba para tu módulo <em>Producto</em>. El primero es <em>testBorrarDesdeLista()</em>
      que selecciona una fila en el modo lista y pulsa en el botón “Borrar
      seleccionados”. Veamos su código:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">public void testBorrarDesdeLista() throws Exception {
    login("admin", "admin");
    setConditionValues("", "JUNIT"); // Establece los valores para filtrar los datos
    setConditionComparators("=", "contains_comparator"); // Pone los comparadores para filtrar los datos
    execute("List.filter"); // Pulsa el botón para filtrar
    assertListRowCount(2); // Verifica que hay 2 filas
    checkRow(1); // Seleccionamos la fila 1 (que resulta ser la segunda)
    execute("CRUD.deleteSelected"); // Pulsa en el botón para borrar
    assertListRowCount(1); // Verifica que ahora solo hay una fila
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Aquí filtramos en modo lista todos
      los productos que contienen la palabra “JUNIT” (recuerda que has creado
      dos de estos en el método <em>crearProductos()</em>), entonces
      verificamos que hay dos filas, seleccionamos el segundo producto y lo
      borramos, verificando al final que la lista se queda con un solo producto.<br>
      Has aprendido como seleccionar una fila (usando <em>checkRow()</em>) y
      como verificar el número de filas (usando <em>assertListRowCount()</em>).
      Quizás la parte más intrincada es usar <em>setConditionValues()</em> y <em>setConditionComparators()</em>.
      Ambos métodos reciben una cantidad variable de cadenas con valores y
      comparadores para la condición, tal como se muestra aquí:<br>
      <img src="files/testing_es050.png" alt="testing_es050.png" title="testing_es050.png"><br>
      Los valores son asignados al filtro de la lista secuencialmente (de
      izquierda a derecha). En este caso hay dos valores, pero puedes usar todos
      los que necesites. No es necesario que especifiques todos los valores. El
      método <em>setConditionValues()</em> admite cualquier cadena mientras que
      <em>setConditionComparators()</em> admite los siguientes valores posibles:
      <em>contains_comparator,</em><em><em> starts_comparator, </em>
        ends_comparator, not_contains_comparator, empty_comparator,
        not_empty_comparator, =, &lt;&gt;, &gt;=, &lt;=, &gt;,</em> <em>&lt;,
        in_comparator</em>, <em>not_in_comparator</em> y <em>range_comparator</em>.<br>
      <h3 id="toc10"><a name="Leccion+3:+Pruebas+automaticas-Crear+datos+de+prueba+usando+JPA-Usar+instancias+de+entidad+dentro+de+una+prueba"></a>Usar
        instancias de entidad dentro de una prueba</h3>
      La prueba que queda, <em>testCambiarPrecio()</em>, simplemente escoge un
      producto y cambia su precio. Vamos a usar en él una entidad creada en <em>crearProductos()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">public void testCambiarPrecio() throws Exception {
    login("admin", "admin");
 
    // Buscar producto1
    execute("CRUD.new");
    setValue("numero", Integer.toString(producto1.getNumero())); // (1)
    execute("CRUD.refresh");
    assertValue("precio", "10,00");
 
    // Cambiar el precio
    setValue("precio", "12,00");
    execute("CRUD.save");
    assertNoErrors();
    assertValue("precio", "");
 
    // Verificar
    setValue("numero", Integer.toString(producto1.getNumero())); // (1)
    execute("CRUD.refresh");
    assertValue("precio", "12,00");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Lo único nuevo en esta prueba es
      que para dar valor al número usado para buscar el producto, lo obtenemos
      de <em>producto1.getNumero()</em> (1). Recuerda que <em>producto1</em>
      es una variable de instancia de la prueba a la que se asigna valor en <em>crearProductos()</em>,
      el cual es llamado desde <em>setUp()</em>, es decir se ejecuta antes de
      cada prueba.<br>
      <br>
      Ya tienes la prueba para <em>Producto</em> y al mismo tiempo has
      aprendido como probar usando datos de prueba creados mediante JPA.
      Ejecútalo, debería salir verde.<br>
      <h2 id="toc11"><a name="Leccion+3:+Pruebas+automaticas-Usar+datos+ya+existentes+para+probar"></a>Usar
        datos ya existentes para probar</h2>
      A veces puedes simplificar la prueba usando una base de datos que contenga
      los datos necesarios para la prueba. Si no quieres probar la creación de
      datos desde el módulo, y no borras datos en la prueba, ésta puede ser una
      buena opción.<br>
      Por ejemplo, puedes probar <em>Autor</em> y <em>Categoria</em> con una
      prueba tan simple como esta:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.tuempresa.facturacion.pruebas;
 
import org.openxava.tests.*;
 
public class PruebaAutor extends ModuleTestBase {
 
    public PruebaAutor(String nombrePrueba) {
        super(nombrePrueba, "Facturacion", "Autor");
    }
 
    public void testReadAuthor() throws Exception {
        login("admin", "admin");
        assertValueInList(0, 0, "JAVIER CORCOBADO"); // El primer autor en la
                                                    // lista es JAVIER CORCOBADO
        execute("List.viewDetail", "row=0"); // Pulsamos en la primera fila
        assertValue("nombre", "JAVIER CORCOBADO");
        assertCollectionRowCount("productos", 2); // Tiene 2 productos
        assertValueInCollection("productos", 0, // Fila 0 de productos
                                "numero", "2"); // tiene “2” en la columna “numero”
        assertValueInCollection("productos", 0, "descripcion", "Arco iris de lágrimas");
        assertValueInCollection("productos", 1, "numero", "3");
        assertValueInCollection("productos", 1, "descripcion", "Ritmo de sangre");
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Esta prueba verifica que el primer
      autor en la lista es “JAVIER CORCOBADO”, recuerda crearlo antes de
      ejecutar la prueba. Entonces va al detalle y confirma que tiene una
      colección llamada "productos" con 2 productos: “Arco iris de lágrimas” y
      “Ritmo de sangre”, antes de ejecutar la prueba créalos y asocialos a
      "JAVIER CORCOBADO". De paso, has aprendido como usar los métodos <em>assertValueInList()</em>,
      <em>assertValueInCollection()</em> y <em>assertCollectionRowCount()</em>.<br>
      Podemos usar la misma técnica para probar el módulo <em>Categoria</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.tuempresa.facturacion.pruebas;
 
import org.openxava.tests.*;
 
public class PruebaCategoria extends ModuleTestBase {
 
    public PruebaCategoria(String nombrePrueba) {
        super(nombrePrueba, "Facturacion", "Categoria");
    }
 
    public void testCategoriasEnLista() throws Exception {
        login("admin", "admin");
        assertValueInList(0, 0, "MÚSICA"); // Fila 0 columna 0 tiene “MÚSICA”
        assertValueInList(1, 0, "LIBROS"); // Fila 1 columna 0 tiene “LIBROS”
        assertValueInList(2, 0, "SOFTWARE"); // Fila 2 columna 0 tiene “SOFTWARE”
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">En este caso solo verificamos que
      en la lista las tres primeras categorías son “MÚSICA”, “LIBROS” y
      “SOFTWARE”. Acuerdate de crearlos antes de ejecutar esta prueba.<br>
      Puedes ver como la técnica de usar datos preexistentes de una base de
      datos de prueba te permite crear pruebas más simples. Empezar con una
      prueba simple e ir complicándolo bajo demanda es una buena idea. Recuerda
      añadir los datos correspondientes usando los módulos antes de ejecutar
      estas pruebas.<br>
      <h2 id="toc12"><a name="Leccion+3:+Pruebas+automaticas-Probar+colecciones"></a>Probar
        colecciones</h2>
      Es el momento de enfrentarnos a la prueba del módulo principal de tu
      aplicación, <em>PruebaFactura</em>. Por ahora la funcionalidad del módulo
      <em>Factura</em> es limitada, solo puedes añadir, borrar y modificar
      facturas. Aun así, esta es la prueba más extensa; además contiene una
      colección, por tanto aprenderás como probar las colecciones.<br>
      <h3 id="toc13"><a name="Leccion+3:+Pruebas+automaticas-Probar+colecciones-Dividir+la+prueba+en+varios+metodos"></a>Dividir
        la prueba en varios métodos</h3>
      La prueba para crear una factura está dividida en varios métodos:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.tuempresa.facturacion.pruebas;
 
import java.util.*;<br>import java.time.*;
import java.time.format.*;<br>import javax.persistence.*;
import org.openxava.tests.*;
import org.openxava.util.*;
import static org.openxava.jpa.XPersistence.*; // Para usar JPA
 
public class PruebaFactura extends ModuleTestBase {
 
    private String numero; // Para almacenar el número de la factura que probamos
 
    public PruebaFactura(String nombrePrueba) {
        super(nombrePrueba, "Facturacion", "Factura");
    }
 
    public void testCrear() throws Exception { // El método de prueba
        login("admin", "admin");
        verificarValoresDefecto();
        escogerCliente();
        anyadirDetalles();
        ponerOtrasPropiedades();
        grabar();
        verificarCreado();
        borrar();
    }
 
    private void verificarValoresDefecto() throws Exception { … }
 
    private void escogerCliente() throws Exception { … }
 
    private void anyadirDetalles() throws Exception { … }
 
    private void ponerOtrasPropiedades() throws Exception { … }
 
    private void grabar() throws Exception { … }
 
    private void verificarCreado() throws Exception { … }
 
    private void borrar() throws Exception { … }
 
    private String getAnyoActual() { … }
 
    private String getFechaActual() { … }
 
    private String getNumero() { … }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">El único método de prueba de esta
      clase es <em>testCrear()</em>, pero dado que es bastante extenso, es
      mejor dividirlo en varios métodos más pequeños. De hecho, es una buena
      práctica de orientación a objetos escribir métodos cortos.<br>
      Ya que el método es corto puedes ver con un solo golpe de vista que es lo
      que hace. En este caso verifica los valores por defecto para una factura
      nueva, escoge un cliente, añade las líneas de detalle, añade otras
      propiedades, graba la factura, verifica que ha sido guardada correctamente
      y al final la borra. Entremos en los detalles de cada uno de estos pasos.<br>
      <h3 id="toc14"><a name="Leccion+3:+Pruebas+automaticas-Probar+colecciones-Verificar+valores+por+defecto"></a>Verificar
        valores por defecto</h3>
      Lo primero es verificar que los valores por defecto para una factura nueva
      son calculados correctamente. Esto se hace en el método <em>verificarValoresDefecto()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void verificarValoresDefecto() throws Exception {
    execute("CRUD.new");
    assertValue("anyo", getAnyoActual());
    assertValue("numero", getNumero());
    assertValue("fecha", getFechaActual());
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Cuando el usuario pulsa en
      “Nuevo”, los campos año, número y fecha tienen que rellenarse con datos
      válidos. El método <em>verificarValoresDefecto()</em> precisamente
      comprueba esto. Usa varios métodos de utilidad para calcular los valores
      esperados:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private String getAnyoActual() { // Año actual en formato cadena
    return Integer.toString(LocalDate.now().getYear()); // La forma
                                            // típica de hacerlo con Java
}
 
private String getFechaActual() { // Fecha actual como una cadena
    return LocalDate.now().format( // La forma típica de hacerlo con Java
        DateTimeFormatter.ofPattern("dd/MM/yyyy"));
}
 
private String getNumero() { // El número de factura para una factura nueva
    if (numero == null) { // Usamos inicialización vaga
        Query query = getManager(). // Una consulta JPA para obtener el último número
                createQuery("select max(f.numero) from Factura f where f.anyo = :anyo");
        query.setParameter("anyo", Dates.getYear(new Date()));  // Dates es una
                                                                // utilidad de OpenXava
        Integer ultimoNumero = (Integer) query.getSingleResult();
        if (ultimoNumero == null) ultimoNumero = 0;
        numero = Integer.toString(ultimoNumero + 1); // Añadimos 1 al
                                                     // último número de factura
    }
    return numero;
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Los métodos <em>getAnyoActual()</em>
      y <em>getFechaActual()</em> usan técnicas clásicas de Java para formatear
      la fecha como una cadena.<br>
      El método <em>getNumero()</em> es un poco más complejo: usa JPA para
      calcular el último número de factura del año en curso y después devuelve
      este valor más uno. Dado que acceder a la base de datos es más pesado que
      un simple cálculo Java, usamos una inicialización vaga. Una inicialización
      vaga retrasa el cálculo hasta la primera vez que se necesita y después lo
      almacena para futuros usos. Esto lo hacemos guardando el valor en el campo
      <em>numero</em>.<br>
      Fíjate en el uso de la clase <em>Dates</em> para extraer el año de la
      fecha. <em>Dates</em> es una clase de utilidad que puedes encontrar en <em>org.openxava.util</em>.<br>
      <h3 id="toc15"><a name="Leccion+3:+Pruebas+automaticas-Probar+colecciones-Entrada+de+datos"></a>Entrada
        de datos</h3>
      Ahora es el momento de <em>escogerCliente()</em> de la factura:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void escogerCliente() throws Exception {
    setValue("cliente.numero", "1");
    assertValue("cliente.nombre", "JAVIER PANIZA"); // El cliente 1 debe de existir en la DB
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Al introducir el número de cliente
      el nombre del cliente se rellena con un valor apropiado. La prueba confía
      en que el cliente 1 con nombre "JAVIER PANIZA" existe, deberías crearlo
      antes de ejecutar la prueba. Ya hemos asociamos el cliente 1 con la
      factura actual.<br>
      Y ahora viene la parte más peliaguda de la prueba: añadir las líneas de
      detalle:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void anyadirDetalles() throws Exception {
    assertCollectionRowCount("detalles", 0); // La colección esta vacía
 
    // Añadir una línea de detalle
    setValueInCollection("detalles", 0, // 0 es la primera fila
        "producto.numero", "1");
    assertValueInCollection("detalles", 0,
        "producto.descripcion", "Peopleware: Productive Projects and Teams");
    setValueInCollection("detalles", 0, "cantidad", "2");
 
    // Añadir otro detalle
    setValueInCollection("detalles", 1, "producto.numero", "2");
    assertValueInCollection("detalles", 1, "producto.descripcion", "Arco iris de lágrimas");
    setValueInCollection("detalles", 1, "cantidad", "1");
 
    assertCollectionRowCount("detalles", 2); // Ahora tenemos 2 filas
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Probar una colección es
      exactamente igual que probar cualquier otra parte de tu aplicación, solo
      has de seguir los mismos pasos que un usuario haría con el navegador.
      Tienes métodos como <em>setValueInCollection()</em>, <em>assertValueInCollection()</em>
      o <em>assertCollectionRowCount()</em> para trabajar con colecciones. Nota
      que estos métodos tienen el nombre de la colección como primer argumento y
      algunos reciben el número de fila siendo el 0 la primera fila. Recuerda
      añadir a la base de datos los productos 1 y 2 con sus correspondientes
      descripciones antes de ejecutar esta prueba.<br>
      Ahora que tenemos los detalles añadidos, vamos a llenar los datos
      restantes y grabar la factura. Los datos restantes se establecen en el
      método <em>ponerOtrasPropiedades()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void ponerOtrasPropiedades() throws Exception {
    setValue("observaciones", "Esto es una prueba JUNIT");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Aquí ponemos valor al campo <em>observaciones</em>.
      Y ahora estamos listos para grabar la factura:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void grabar() throws Exception {
    execute("CRUD.save");
    assertNoErrors();
    assertValue("cliente.numero", "");
    assertCollectionRowCount("detalles", 0);
    assertValue("observaciones", "");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Simplemente pulsa en “Grabar”,
      entonces verifica que no ha habido errores y la vista se ha limpiado.<br>
      <h3 id="toc16"><a name="Leccion+3:+Pruebas+automaticas-Probar+colecciones-Verificar+los+datos"></a>Verificar
        los datos</h3>
      Ahora, buscamos la factura recién creada para verificar que ha sido
      grabada correctamente. Esto se hace en el método <em>verificarCreado()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void verificarCreado() throws Exception {
    setValue("anyo", getAnyoActual()); // El año actual en el campo año
    setValue("numero", getNumero()); // El número de la factura usada en la prueba
    execute("CRUD.refresh"); // Carga la factura desde la base de datos
 
    // En el resto de la prueba confirmamos que los valores son los correctos
    assertValue("anyo", getAnyoActual());
    assertValue("numero", getNumero());
    assertValue("fecha", getFechaActual());
    assertValue("cliente.numero", "1");
    assertValue("cliente.nombre", "JAVIER PANIZA");
    assertCollectionRowCount("detalles", 2);
 
    // Fila 0
    assertValueInCollection("detalles", 0, "producto.numero", "1");
    assertValueInCollection("detalles", 0, "producto.descripcion",
        "Peopleware: Productive Projects and Teams");
    assertValueInCollection("detalles", 0, "cantidad", "2");
 
    // Fila 1
    assertValueInCollection("detalles", 1, "producto.numero", "2");
    assertValueInCollection("detalles", 1, "producto.descripcion",
        "Arco iris de lágrimas");
    assertValueInCollection("detalles", 1, "cantidad", "1");
    assertValue("observaciones", "Esto es una prueba JUNIT");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Después de buscar la factura
      creada verificamos que los valores que hemos grabado están ahí. Si la
      prueba llega a este punto tu módulo <em>Factura</em> funciona bien. Solo
      nos queda borrar la factura creada para que la prueba se pueda ejecutar la
      siguiente vez. Hacemos esto en el método <em>borrar()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void borrar() throws Exception {
    execute("CRUD.delete");
    assertNoErrors();
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Simplemente presiona en “Borrar” y
      verifica que no se han producido errores.<br>
      <br>
      ¡Enhorabuena! Has completado tu <em>PruebaFactura</em>. Ya puedes
      ejecutarla, debería salir verde, si no comprueba que los datos en la base
      de datos están bien, puede que tengas que añadir los productos, cliente,
      etc. correspondientes.<br>
      <h2 id="toc17"><a name="Leccion+3:+Pruebas+automaticas-Suite"></a>Suite</h2>
      Tienes 5 casos de prueba que velan por tu código, preservando la calidad
      de tu aplicación. Cuando termines alguna mejora o corrección en tu
      aplicación ejecuta todas tus pruebas unitarias para verificar que la
      funcionalidad existente no se ha roto.<br>
      Tradicionalmente, para ejecutar todos las pruebas de tu aplicación
      deberías crear una suite de pruebas, y ejecutarla. Una suite de pruebas es
      una clase que agrega todas tus pruebas JUnit para que puedas ejecutarlas
      todas de un golpe. Afortunadamente, si trabajas con Eclipse no necesitas
      escribir una clase de suite, Eclipse te permite ejecutar todas las pruebas
      de tu aplicación automáticamente:<br>
      <img src="files/testing_es060.png" alt="testing_es060.png" title="testing_es060.png"><br>
      Es decir, si ejecutas <em>Run As &gt; JUnit Test</em> en el proyecto, se
      ejecutarán todas sus pruebas JUnit.<br>
      <h2 id="toc18"><a name="Leccion+3:+Pruebas+automaticas-Resumen"></a>Resumen</h2>
      Has automatizado las pruebas de toda la funcionalidad actual de tu
      aplicación. Puede parecer que este código de prueba es mucho más largo y
      aburrido que el código real de la aplicación. Pero recuerda, el código de
      prueba es el tesoro más valioso que tienes. Quizás ahora no me creas, pero
      trata de hacer pruebas JUnit y una vez te hayan salvado la vida, ya no
      podrás desarrollar sin pruebas automáticas nunca más.<br>
      ¿Qué probar? No hagas pruebas exhaustivas al principio. Es mejor probar
      poco que no probar nada. Si tratas de hacer pruebas muy exhaustivas
      acabarás no haciendo pruebas en absoluto. Empieza haciendo algunas pruebas
      JUnit para tu código, y con cada nueva característica o nuevo arreglo
      añade nuevas pruebas. Al final, tendrás una suite de pruebas muy completa.
      En resumen, prueba poco, pero prueba siempre.<br>
      Sí, hacer pruebas automáticas es una tarea continua. Y para predicar con
      el ejemplo a partir de ahora escribiremos todas las pruebas para el código
      que desarrollemos en el resto del libro. De esta manera aprenderás más
      trucos sobre las pruebas JUnit en las siguientes lecciones.<br>
      <br>
      <strong><a class="wiki_link_ext" href="https://sourceforge.net/projects/openxava/files/openxava-course-source-code/openxava-course-source-code-lesson-3-testing_es.zip/download"
          rel="nofollow">Descargar código fuente de esta lección</a></strong><br>
      <br>
      <strong>¿Problemas con la lección? <a class="wiki_link_ext" href="http://sourceforge.net/p/openxava/discussion/437013/"
          rel="nofollow">Pregunta en el foro</a></strong> <strong>¿Ha ido bien?
        <a class="wiki_link" href="inheritance_es.html">Ve a la lección 4</a></strong>
    </div>
  </body>
</html>
