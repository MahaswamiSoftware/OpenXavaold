<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>openxava - testing_en</title>
    <link rel="stylesheet" href="static/style.css" type="text/css">
    <link rel="stylesheet" href="highlight/highlight.css">
    <script src="highlight/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div class="wiki" id="content_view" style="display: block;">
      <div id="toc">
        <h1 class="nopad">Table of Contents</h1>
        <div style="margin-left: 1em;"><a href="#Lesson%203:%20Automated%20testing">Lesson
            3: Automated testing</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-JUnit">JUnit</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-ModuleTestBase%20for%20testing%20the%20modules">ModuleTestBase
            for testing the modules</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-ModuleTestBase%20for%20testing%20the%20modules-The%20code%20for%20the%20test">The
            code for the test</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-ModuleTestBase%20for%20testing%20the%20modules-Executing%20the%20tests%20from%20Eclipse">Executing
            the tests from Eclipse</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA">Creating
            test data using JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA-Using%20setUp%28%29%20and%20tearDown%28%29%20methods">Using
            setUp() and tearDown() methods</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA-Creating%20data%20with%20JPA">Creating
            data with JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA-Removing%20data%20with%20JPA">Removing
            data with JPA</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA-Filtering%20data%20from%20list%20mode%20in%20a%20test">Filtering
            data from list mode in a test</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Creating%20test%20data%20using%20JPA-Using%20entity%20instances%20inside%20a%20test">Using
            entity instances inside a test</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-Using%20existing%20data%20for%20testing">Using
            existing data for testing</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-Testing%20collections">Testing
            collections</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Testing%20collections-Breaking%20down%20tests%20in%20several%20methods">Breaking
            down tests in several methods</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Testing%20collections-Asserting%20default%20values">Asserting
            default values</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Testing%20collections-Data%20entry">Data
            entry</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%203:%20Automated%20testing-Testing%20collections-Verifying%20the%20data">Verifying
            the data</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-Suite">Suite</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%203:%20Automated%20testing-Summary">Summary</a></div>
      </div>
      <strong>Course</strong>: <a class="wiki_link" href="getting-started_en.html">1.
        Getting started</a> | <a class="wiki_link" href="modeling_en.html">2.
        Modeling with Java</a> | <strong>3. Automated testing</strong> | <a class="wiki_link"

        href="inheritance_en.html">4. Inheritance</a> | <a class="wiki_link" href="basic-business-logic_en.html">5.
        Basic business logic</a> | <a class="wiki_link" href="validation_en.html">6.
        Advanced validation</a> | <a class="wiki_link" href="refining-standard-behavior_en.html">7.
        Refining the standard behavior</a> | <a class="wiki_link" href="business-logic-behavior_en.html">8.
        Behavior &amp; business logic</a> | <a class="wiki_link" href="references-collections_en.html">9.
        References &amp; collections</a> | <a class="wiki_link" href="philosophy_en.html">A.
        Architecture &amp; philosophy</a> | <a class="wiki_link" href="jpa_en.html">B.
        Java Persistence API</a> | <a class="wiki_link" href="annotations_en.html">C.
        Annotations</a><br>
      <h1 id="toc0"><a name="Lesson 3: Automated testing"></a>Lesson 3:
        Automated testing</h1>
      Good testing is the most important part of software development. It does
      not matter how beautiful, or fast, or high-tech your application is, if it
      crashes, you leave a poor impression and, crucially, your customer can
      lose valuable data.<br>
      Manual testing of the application as an end user is not a viable way to
      test, because the real problem is not the code you have written, but the
      existing code. Usually you test the code you have just written, but you do
      not retest all the already existing code in your application. And you know
      that when you touch any part of the code you can break any other part of
      the application.<br>
      While making any changes to your code, you want to handle it with the
      immense responsibility to keep the application from breaking. The best way
      to accomplish this is by using automatic testing. We are going to use
      automatic testing by means of JUnit.<br>
      <h2 id="toc1"><a name="Lesson 3: Automated testing-JUnit"></a>JUnit</h2>
      JUnit is a popular tool for doing automated testing. This tool comes
      integrated with Eclipse, so you do not need to download it. OpenXava
      extends the capacities of JUnit, allowing you to test an OpenXava module
      exactly in the same way an end user would. In fact, OpenXava uses
      HtmlUnit, software that simulates a real browser (including JavaScript)
      from Java. All this is available from the OpenXava class <em>ModuleTestBase</em>.
      It allows you to automate the test you would do by hand using a real
      browser in a simple way.<br>
      The best way to understand testing in OpenXava is to see it in action.<br>
      <h2 id="toc2"><a name="Lesson 3: Automated testing-ModuleTestBase for testing the modules"></a>ModuleTestBase
        for testing the modules</h2>
      The way to create a test for an OpenXava module is by extending the <em>ModuleTestBase</em>
      class from <em>org.openxava.tests</em> package. It connects to the
      OpenXava module as a real browser, and has a lot of methods that allows
      you to test your module. Let's create the test for your <em>Customer</em>
      module.<br>
      <h3 id="toc3"><a name="Lesson 3: Automated testing-ModuleTestBase for testing the modules-The code for the test"></a>The
        code for the test</h3>
      Create a new package named <em>com.yourcompany.invoicing.tests</em> and then
      create a new class named <em>CustomerTest</em> inside it with the next
      code:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.yourcompany.invoicing.tests;
 
import org.openxava.tests.*;
 
public class CustomerTest extends ModuleTestBase { // Must extend from ModuleTestBase
 
    public CustomerTest(String testName) {
        super(testName, "Invoicing", // We indicate the application name (Invoicing)
                "Customer"); // and the module name (Customer)
    }
 
    // The test methods must start with 'test'
    public void testCreateReadUpdateDelete() throws Exception {
        login("admin", "admin"); // The user sign in to access the module
 
        // Create
        execute("CRUD.new"); // Clicks on 'New' button
        setValue("number", "77"); // Types 77 as the value for the 'number' field
        setValue("name", "JUNIT Customer"); // Sets the value for the 'name' field
        setValue("address.street", "JUNIT Street"); // Note the dot notation
                                                // to access a reference member
        setValue("address.zipCode", "77555"); // Etc
        setValue("address.city", "The JUNIT city"); // Etc
        setValue("address.state", "The JUNIT state"); // Etc
        execute("CRUD.save"); // Clicks on 'Save' button
        assertNoErrors(); // Verifies that the application does not show errors
        assertValue("number", ""); // Verifies the 'number' field is empty
        assertValue("name", ""); // Verifies the 'name' field is empty
        assertValue("address.street", ""); // Etc
        assertValue("address.zipCode", ""); // Etc
        assertValue("address.city", ""); // Etc
        assertValue("address.state", ""); // Etc
 
        // Read
        setValue("number", "77"); // Types 77 as the value for the 'number' field
        execute("CRUD.refresh"); // Clicks on 'Refresh' button
        assertValue("number", "77"); // Verifies the 'number' field has 77
        assertValue("name", "JUNIT Customer"); // and 'name' has 'JUNIT Customer'
        assertValue("address.street", "JUNIT Street"); // Etc
        assertValue("address.zipCode", "77555"); // Etc
        assertValue("address.city", "The JUNIT city"); // Etc
        assertValue("address.state", "The JUNIT state"); // Etc
 
        // Update
        setValue("name", "JUNIT Customer MODIFIED"); // Changes the value
                                                    // of 'name' field
        execute("CRUD.save"); // Clicks on 'Save' button
        assertNoErrors(); // Verifies that the application does not show errors
        assertValue("number", ""); // Verifies the 'number' field is empty
        assertValue("name", ""); // Verifies the 'name' field is empty
 
        // Verify if modified
        setValue("number", "77"); // Types 77 as the value for 'number' field
        execute("CRUD.refresh"); // Clicks on 'Refresh' button
        assertValue("number", "77"); // Verifies the 'number' field has 77
        assertValue("name", "JUNIT Customer MODIFIED"); // and 'name'
                                        // has 'JUNIT Customer MODIFIED'
 
        // Delete
        execute("CRUD.delete"); // Clicks on 'Delete' button
        assertMessage("Customer deleted successfully"); // Verifies that the
                // message 'Customer deleted successfully' is shown to the user
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;"> This test creates a new customer,
      searches it, modifies it, and finally deletes it. You see how you can use
      methods such as <em>execute()</em> or <em>setValue()</em> for simulating
      user actions, and the methods like <em>assertValue()</em>, <em>assertNoErrors()</em>
      or <em>assertMessage()</em> to verify the state of the user interface.
      Your test acts as the hands and eyes of the user:<br>
      <img src="files/testing_en010.png" alt="testing_en010.png" title="testing_en010.png"><br>
      In <em>execute()</em> you must specify the qualified name of the action,
      that means <em>ControllerName.actionName</em>. How can you know it?
      Simple, put your mouse over an action link, and you will see in the status
      bar of your browser a JavaScript code that includes the qualified action
      name:<br>
      <img src="files/testing_en020.png" alt="testing_en020.png" title="testing_en020.png"><br>
      Now, you know how to create a test for testing the basic CRUD operations
      of a module. It's not required to write an exhaustive test at first. Just
      test the basic things, those that you usually test using the browser. Your
      test will naturally grows with your application and as the user feedback
      grows.<br>
      Let's learn how to execute your test from Eclipse.<br>
      <h3 id="toc4"><a name="Lesson 3: Automated testing-ModuleTestBase for testing the modules-Executing the tests from Eclipse"></a>Executing
        the tests from Eclipse</h3>
      As mentioned earlier, JUnit is integrated into Eclipse, so running your
      tests from Eclipse is plain vanilla. Just put your mouse over the test
      class, and with the right button choose <em>Run As &gt; JUnit Test</em>:<br>
      <img src="files/testing_en030.png" alt="testing_en030.png" title="testing_en030.png"

        style="height: 288px; width: 800px;"><br>
      If the test does not pass, the bar will be red. You can try it. Edit the <em>CustomerTest</em>
      and comment the line that sets the value for the <em>name</em> field:<br>
    </div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">...
setValue("number", "77");
// setValue("name", "JUNIT Customer"); // Comment this line
setValue("address.street", "JUNIT Street");
...
</code></pre> </div>
    <div class="wiki" style="display: block;">Now, rerun the test. Since <em>name</em>
      is a required property, an error message will be shown to the user, and
      the object will not be saved:<br>
      <img src="files/testing_en040.png" alt="testing_en040.png" title="testing_en040.png"><br>
      The failed assert is <em>assertNoErrors()</em>, which in addition to
      failure shows the error on the console. So, in the execution console of
      your test you will see the message like this one:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="plaintext">16-jul-2019 18:03 org.openxava.tests.ModuleTestBase assertNoMessages
SEVERE: Error unexpected: Value for Name in Customer is required
</code></pre> </div>
    <div class="wiki" style="display: block;">
      <style type="text/css"><!--
/**
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 */
.text  {font-family:monospace;}
.text .imp {font-weight: bold; color: red;}
.text span.xtra { display:block; }

-->
</style> The problem is clear. The customer is not saved because the name is
      required, and it's not specified.<br>
      You have seen how the test behaves when it fails. Now, you can uncomment
      back the guilty line and run the test again to verify that everything is
      OK.<br>
      <h2 id="toc5"><a name="Lesson 3: Automated testing-Creating test data using JPA"></a>Creating
        test data using JPA</h2>
      In your first test, <em>CustomerTest</em>, the test itself starts
      creating the data that is used in the rest of the test. This is a good way
      to go, especially if you want to test the data entry functionality too.
      But, if you want to test only a small buggy case, or your module simply
      does not allow adding new objects, you can create the data you need for
      testing using JPA from your test.<br>
      <h3 id="toc6"><a name="Lesson 3: Automated testing-Creating test data using JPA-Using setUp() and tearDown() methods"></a>Using
        setUp() and tearDown() methods</h3>
      We are going to use <em>ProductTest</em> to learn how to use JPA for
      creating test data. We'll create some products before each test execution
      and remove them afterwards. Let's see the code for <em>ProductTest</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.yourcompany.invoicing.tests;
 
import java.math.*;
import com.yourcompany.invoicing.model.*;
import org.openxava.tests.*;
import static org.openxava.jpa.XPersistence.*;
 
public class ProductTest extends ModuleTestBase {
 
    private Author author; // We declare the entities to be created
    private Category category; // as instance members in order
    private Product product1; // to be available from inside any test method
    private Product product2; // and to be removed at the end of each test
 
    public ProductTest(String testName) {
        super(testName, "Invoicing", "Product");
    }
 
    protected void setUp() throws Exception { // setUp() is always executed
                                              // before each test
        super.setUp(); // It's needed because ModuleTestBase uses it for
                        // initializing, even JPA is initialized here.
        createProducts(); // Creates the data used in the tests
    }
 
    protected void tearDown() throws Exception { // tearDown() is always
                                                 // executed after each test
        super.tearDown(); // It's needed, ModuleTestBase closes resources here
        removeProducts(); // The data used for testing is removed
    }
 
    public void testRemoveFromList() throws Exception { ... }
 
    public void testChangePrice() throws Exception { ... }
 
    private void createProducts() { ... }
 
    private void removeProducts() { ... }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Here we are overwriting the <em>setUp()</em>
      and <em>tearDown()</em> methods. These methods are JUnit methods that are
      executed just before and after each test execution. We create the testing
      data before each test execution, and remove the data after each test
      execution. Thus, each test can rely on the precise data to be executed. It
      does not matter if some other test removes or modifies the data, or the
      execution order of the test. Always, at the beginning of each test we have
      all the data ready to use.<br>
      <h3 id="toc7"><a name="Lesson 3: Automated testing-Creating test data using JPA-Creating data with JPA"></a>Creating
        data with JPA</h3>
      The <em>createProducts()</em> method is responsible for creating the test
      data using JPA. Let's examine it:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void createProducts() {
    // Creating the Java objects
    author = new Author(); // Regular Java objects are created
    author.setName("JUNIT Author"); // We use setters just as in plain Java
    category = new Category();
    category.setDescription("JUNIT Category");
    product1 = new Product();
    product1.setNumber(900000001);
    product1.setDescription("JUNIT Product 1");
    product1.setAuthor(author);
    product1.setCategory(category);
    product1.setPrice(new BigDecimal("10"));
    product2 = new Product();
    product2.setNumber(900000002);
    product2.setDescription("JUNIT Product 2");
    product2.setAuthor(author);
    product2.setCategory(category);
    product2.setPrice(new BigDecimal("20"));
 
    // Marking as persistent objects
    getManager().persist(author); // getManager() is from XPersistence
    getManager().persist(category); // persist() marks the object as persistent
    getManager().persist(product1); // so it will be saved to the database
    getManager().persist(product2);
 
    // Commit changes to the database
    commit(); // commit() is from XPersistence. It saves all object to the database
              // and commits the transaction
}
</code></pre> </div>
    <div class="wiki" style="display: block;">As you can see, first you create
      the Java objects in the Java conventional way. Note that you assign it to
      instance members. Thus you can use it inside tests. Then, you mark them as
      persistent, using the <em>persist()</em> method of the JPA <em>EntityManager</em>.
      To obtain the <em>EntityManager</em> you only have to write <em>getManager()</em>
      because you have the static import above:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">import static org.openxava.jpa.XPersistence.*;
...
getManager().persist(author);
    // Thanks to the XPersistence static import it's the same as
XPersistence.getManager().persist(author);
...
commit();
    // Thanks to the XPersistence static import it's the same as
XPersistence.commit();
</code></pre> </div>
    <div class="wiki" style="display: block;">To finalize, <em>commit()</em>
      (also from <em>XPersistence</em>) saves all the data from objects to
      database and then commits the transaction. After that, the data is in the
      database ready to be used by your test.<br>
      <h3 id="toc8"><a name="Lesson 3: Automated testing-Creating test data using JPA-Removing data with JPA"></a>Removing
        data with JPA</h3>
      After the test is executed we remove the test data in order to leave the
      database clean. This is done by the <em>removeProducts()</em> method:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void removeProducts() { // Called from tearDown() so it's executed
                                // after each test
    remove(product1, product2, author, category); // remove() removes
    commit(); // Commits the changes to database, in this case deleting data
}
 
private void remove(Object ... entities) { // Using varargs argument
    for (Object entity : entities) { // Iterating for all arguments
        getManager().remove(getManager().merge(entity)); // Removing(1)
    }
}
</code></pre> </div>
    <div class="wiki" style="display: block;">It's a simple loop to remove all
      the entities used in the test. To remove an entity in JPA you have to use
      the <em>remove()</em> method, but in this case you have to use the <em>merge()</em>
      method too (shown as 1). This is because you cannot remove a detached
      entity. When you use <em>commit()</em> in <em>createProducts()</em> all
      saved entities become detached entities. This is because they continue
      being valid Java object but the persistent context (the union between
      entities and database) has been lost on <em>commit()</em>, so you must
      reattach them to the new persistent context. This concept is easy to
      understand seeing the next code:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">getManager().persist(author); // author is attached to the current persistence context
commit(); // The current persistence context is over, so author becomes detached
 
getManager().remove(author); // It fails because author is detached
 
author = getManager().merge(author); // Reattaches author to the current context
getManager().remove(author); // It works
</code></pre> </div>
    <div class="wiki" style="display: block;">Apart from this curious detail
      about <em>merge()</em>, the code for removing is quite simple.<br>
      <h3 id="toc9"><a name="Lesson 3: Automated testing-Creating test data using JPA-Filtering data from list mode in a test"></a>Filtering
        data from list mode in a test</h3>
      Now that you know how to create and remove the data for the tests, let's
      examine the test methods for your <em>Product</em> module. The first one
      is <em>testRemoveFromList()</em> that checks a row in list mode and
      clicks on “Delete selected” button. Let's see the code:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">public void testRemoveFromList() throws Exception {
    login("admin", "admin");
    setConditionValues("", "JUNIT"); // Put the values for filtering data
    setConditionComparators("=", "contains_comparator"); // Put the comparators for filtering data
    execute("List.filter"); // Clicks on filter button
    assertListRowCount(2); // Verifies that there are 2 rows
    checkRow(1); // We select row 1 (really the second one)
    execute("CRUD.deleteSelected"); // Clicks on the delete button
    assertListRowCount(1); // Verifies that now there is only 1 row
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Here we filter in list mode all
      products that contain the “JUNIT” word (remember that you have created two
      of them in <em>createProducts()</em> method), then we verify that there
      are two rows, select the second product, and remove it, verifying at the
      end that one product remains in the list.<br>
      You have learned how to select a row (using <em>checkRow()</em>) and how
      to assert the row count (using <em>assertListRowCount()</em>). The
      trickiest part might be filtering the list using <em>setConditionValues()</em>
      and <em>setConditionComparators()</em>. Both methods receive a variable
      number of string arguments with values and comparators for the condition,
      just as shown here:<br>
      <img src="files/testing_en050.png" alt="testing_en050.png" title="testing_en050.png"><br>
      The values are assigned to the list filter user interface sequentially
      (from left to right). In this case there are two values, but you can use
      all you need. You do not need to specify all values. The <em>setConditionValues()</em>
      method accepts any string value whereas <em>setConditionComparators()</em>
      accepts the next possible values: <em><em> contains_comparator, </em>starts_comparator,
ends_comparator,
        not_contains_comparator, empty_comparator, not_empty_comparator, =,
        &lt;&gt;, &gt;=, &lt;=, &gt;,</em> <em>&lt;</em>, <em>in_comparator</em>,
      <em>not_in_comparator</em> and <em>range_comparator</em>.<br>
      <h3 id="toc10"><a name="Lesson 3: Automated testing-Creating test data using JPA-Using entity instances inside a test"></a>Using
        entity instances inside a test</h3>
      The remaining test, <em>testChangePrice()</em>, simply chooses a product
      and changes its price. We are going to use it in an entity created in <em>createProducts()</em>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">public void testChangePrice() throws Exception {
    login("admin", "admin");
 
    // Searching the product1
    execute("CRUD.new");
    setValue("number", Integer.toString(product1.getNumber())); // (1)
    execute("CRUD.refresh");
    assertValue("price", "10.00");
 
    // Changing the price
    setValue("price", "12.00");
    execute("CRUD.save");
    assertNoErrors();
    assertValue("price", "");
 
    // Verifying
    setValue("number", Integer.toString(product1.getNumber())); // (1)
    execute("CRUD.refresh");
    assertValue("price", "12.00");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">The only new thing in this test is
      to provide a value to number to search the product. We get the value using
      <em>product1.getNumber()</em> (shown as 1). Remember that <em>product1</em>
      is an instance variable of the test that is populated in <em>createProducts()</em>,
      which is called from <em>setUp()</em> so it is executed before each test.<br>
      <br>
      You have a test class for <em>Product</em> and at the same time you have
      learned testing with test data created using JPA. Run it, it should be
      green.<br>
      <h2 id="toc11"><a name="Lesson 3: Automated testing-Using existing data for testing"></a>Using
        existing data for testing</h2>
      Sometimes you can simplify the test by relying on a test database which is
      populated with the data needed for testing. If you do not want to test
      data creation from the module itself, and you do not remove data in the
      test, this can be a good option.<br>
      For example, you can test <em>Author</em> and <em>Category</em> with a
      simple test like this one:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.yourcompany.invoicing.tests;
 
import org.openxava.tests.*;
 
public class AuthorTest extends ModuleTestBase {
    public AuthorTest(String testName) {
        super(testName, "Invoicing", "Author");
    }
 
    public void testReadAuthor() throws Exception {
        login("admin", "admin");
        assertValueInList(0, 0, "JAVIER CORCOBADO"); // The first author
                                        // in the list is JAVIER CORCOBADO
        execute("List.viewDetail", "row=0"); // We click the first object in the list
        assertValue("name", "JAVIER CORCOBADO");
        assertCollectionRowCount("products", 2); // It has 2 products
        assertValueInCollection("products", 0, // Row 0 of products
                                "number", "2"); // has “2” in “number” column
        assertValueInCollection("products", 0, "description", "Arco iris de lágrimas");
        assertValueInCollection("products", 1, "number", "3");
        assertValueInCollection("products", 1, "description", "Ritmo de sangre");
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">This test verifies that the first
      author in the list is “JAVIER CORCOBADO”, remember to create it before
      executing the test. It goes to the detail and asserts that it has a
      collection called "products" with 2 products: “Arco iris de lágrimas” and
      “Ritmo de sangre”, before executing the test create them and associate
      them to "JAVIER CORCOBADO". By the way, now you have learned how to use <em>assertValueInList()</em>,
      <em>assertValueInCollection()</em> and <em>assertCollectionRowCount()</em>
      methods.<br>
      We can use the same technique to test the <em>Category</em> module:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.yourcompany.invoicing.tests;
 
import org.openxava.tests.*;
 
public class CategoryTest extends ModuleTestBase {
 
    public CategoryTest(String testName) {
        super(testName, "Invoicing", "Category");
    }
 
    public void testCategoriesInList() throws Exception {
        login("admin", "admin");
        assertValueInList(0, 0, "MUSIC"); // Row 0 column 0 has “MUSIC”
        assertValueInList(1, 0, "BOOKS"); // Row 1 column 0 has “BOOKS”
        assertValueInList(2, 0, "SOFTWARE"); // Row 2 column 0 has “SOFTWARE”
    }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">In this case we see that in the
      list the first three categories are “MUSIC”, “BOOKS” and “SOFTWARE”.
      Remember to create them before executing the test.<br>
      You have seen how the technique of using pre-existing data from a test
      database allows you to create simpler tests. Starting from a simple test
      and further complicating it on demand is a good way to go. Remember to add
      the corresponding data using the modules before executing these tests.<br>
      <h2 id="toc12"><a name="Lesson 3: Automated testing-Testing collections"></a>Testing
        collections</h2>
      Now it's time to face the test for the main module of your application,
      the <em>InvoiceTest</em>. As of now the functionality of the <em>Invoice</em>
      module is limited. You can only add, remove and modify invoices. Even so,
      this is a big test. It contains a collection, so you will learn here how
      to test collections.<br>
      <h3 id="toc13"><a name="Lesson 3: Automated testing-Testing collections-Breaking down tests in several methods"></a>Breaking
        down tests in several methods</h3>
      The test for creating an <em>Invoice</em> is broken down into several
      methods:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">package com.yourcompany.invoicing.tests;
 
import java.util.*;<br>import java.time.*;
import java.time.format.*;<br>import javax.persistence.*;
import org.openxava.tests.*;
import org.openxava.util.*;
import static org.openxava.jpa.XPersistence.*; // To use JPA
 
public class InvoiceTest extends ModuleTestBase {
 
    private String number; // To store the number of the tested invoice
 
    public InvoiceTest(String testName) {
        super(testName, "Invoicing", "Invoice");
    }
 
    public void testCreate() throws Exception { // The test method
        login("admin", "admin");
        verifyDefaultValues();
        chooseCustomer();
        addDetails();
        setOtherProperties();
        save();
        verifyCreated();
        remove();
    }
 
    private void verifyDefaultValues() throws Exception { … }
 
    private void chooseCustomer() throws Exception { … }
 
    private void addDetails() throws Exception { … }
 
    private void setOtherProperties() throws Exception { … }
 
    private void save() throws Exception { … }
 
    private void verifyCreated() throws Exception { … }
 
    private void remove() throws Exception { … }
 
    private String getCurrentYear() { … }
 
    private String getCurrentDate() { … }
 
    private String getNumber() { … }
 
}
</code></pre> </div>
    <div class="wiki" style="display: block;">The only test method in this class
      is <em>testCreate()</em>, but because this test is somewhat large, it is
      better to break it down into several shorter methods. In fact, it's a good
      object-oriented practice to write short methods.<br>
      Because this method is short you can see in a glance what it does. In this
      case the method verifies the default values for a new invoice, chooses a
      customer, adds the details, adds other properties, saves the invoice,
      verifies that it is correctly saved and finally deletes it. Let's dip into
      the details of these steps.<br>
      <h3 id="toc14"><a name="Lesson 3: Automated testing-Testing collections-Asserting default values"></a>Asserting
        default values</h3>
      First, it verifies whether the default values for a new invoice are
      correctly calculated or not. This is done by the <em>verifyDefaultValues()</em>
      method:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void verifyDefaultValues() throws Exception {
    execute("CRUD.new");
    assertValue("year", getCurrentYear());
    assertValue("number", getNumber());
    assertValue("date", getCurrentDate());
}
</code></pre> </div>
    <div class="wiki" style="display: block;">When the user clicks on “New”, the
      year, number and date field must be prefilled with valid data. The <em>verifyDefaultValues()</em>
      method tests this. It uses several utility methods to calculate the
      expected values:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private String getCurrentYear() { // Current year in string format
    return Integer.toString(LocalDate.now().getYear()); // The standard
                                                    // way to do it with Java
}
 
private String getCurrentDate() { // Current date as string in short format
    return LocalDate.now().format( // The standard way to do it with Java
        DateTimeFormatter.ofLocalizedDate(FormatStyle.SHORT));
}
 
private String getNumber() { // The invoice number for a new invoice
    if (number == null) { // We use lazy initialization
        Query query = getManager(). // A JPA query to get the last number
                createQuery("select max(i.number) from Invoice i where i.year = :year");
        query.setParameter("year", Dates.getYear(new Date()));     // Dates is an
                                                                // OpenXava utility
        Integer lastNumber = (Integer) query.getSingleResult();
        if (lastNumber == null) lastNumber = 0;
        number = Integer.toString(lastNumber + 1); // Adding 1 to the last invoice number
    }
    return number;
}
</code></pre> </div>
    <div class="wiki" style="display: block;">The <em>getCurrentYear()</em> and
      <em>getCurrentDate()</em> methods use classic Java techniques to format
      the date as string.<br>
      The <em>getNumber()</em> method, on the other hand, is a little more
      complex. It uses JPA to calculate the last invoice number of the current
      year, then return this value plus one. Due to its access to the database
      it is heavier than a simple Java calculation, therefore we use lazy
      initialization. Lazy initialization delays the calculation until the first
      time it is needed, and stores it for future use. We do it by saving the
      value in the number field.<br>
      Note the usage of the <em>Dates</em> class to extract the year from the
      date. <em>Dates</em> is a utility class you can find in <em>org.openxava.util</em>.<br>
      <h3 id="toc15"><a name="Lesson 3: Automated testing-Testing collections-Data entry"></a>Data
        entry</h3>
      Now it's time for the <em>chooseCustomer()</em> method of the invoice:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void chooseCustomer() throws Exception {
    setValue("customer.number", "1");
    assertValue("customer.name", "JAVIER PANIZA"); // The customer 1 should exist in DB
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Upon entry of the customer number
      the customer name is simply filled with the appropriate value. Since the
      test relies on customer 1 with name "JAVIER PANIZA" existing already, you
      should create it before running the test. With this the customer 1 is
      associated to the current invoice.<br>
      And now comes the most tricky part of the test: adding the detail lines:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void addDetails() throws Exception {
    assertCollectionRowCount("details", 0); // The collection is empty
 
    // Adding a detail line
    setValueInCollection("details", 0, // 0 means the first row
        "product.number", "1");
    assertValueInCollection("details", 0,
        "product.description", "Peopleware: Productive Projects and Teams");
    setValueInCollection("details", 0, "quantity", "2");
 
    // Adding another detail
    setValueInCollection("details", 1, "product.number", "2");
    assertValueInCollection("details", 1, "product.description", "Arco iris de lágrimas");
    setValueInCollection("details", 1, "quantity", "1");
 
    assertCollectionRowCount("details", 2); // Now we have 2 rows
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Testing a collection is the same
      as testing any other part of your application. You have to follow the same
      steps as an end user with a browser. You have methods such as <em>setValueInCollection()</em>,
      <em>assertValueInCollection()</em> or <em>assertCollectionRowCount()</em>
      to work with collections. Note how these methods have the collection name
      as first argument, and some of them receive the row number with 0 based
      index. Remember to create the product 1 and 2 with the corresponding
      descriptions before executing this test.<br>
      Now that we have the details added, we are going to fill the remaining
      data and save the invoice. The remaining data is set by <em>setOtherProperties()</em>
      method:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void setOtherProperties() throws Exception {
    setValue("remarks", "This is a JUNIT test");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">Here we give a value to the <em>remarks</em>
      field. Now we are ready to save the invoice:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void save() throws Exception {
    execute("CRUD.save");
    assertNoErrors();
    assertValue("customer.number", "");
    assertCollectionRowCount("details", 0);
    assertValue("remarks", "");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">It simply clicks on “Save”, then
      verifies for any errors and makes sure that the view is clean.<br>
      <h3 id="toc16"><a name="Lesson 3: Automated testing-Testing collections-Verifying the data"></a>Verifying
        the data</h3>
      Now, we will search the newly created invoice to verify that it has been
      saved correctly. This is done by the <em>verifyCreated()</em> method:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void verifyCreated() throws Exception {
    setValue("year", getCurrentYear()); // The current year to year field
    setValue("number", getNumber()); // The invoice number of the test
    execute("CRUD.refresh"); // Load the invoice back from the database
 
    // In the rest of the test we assert that the values are the correct ones
    assertValue("year", getCurrentYear());
    assertValue("number", getNumber());
    assertValue("date", getCurrentDate());
    assertValue("customer.number", "1");
    assertValue("customer.name", "JAVIER PANIZA");
    assertCollectionRowCount("details", 2);
 
    // Row 0
    assertValueInCollection("details", 0, "product.number", "1");
    assertValueInCollection("details", 0, "product.description",
        "Peopleware: Productive Projects and Teams");
    assertValueInCollection("details", 0, "quantity", "2");
 
    // Row 1
    assertValueInCollection("details", 1, "product.number", "2");
    assertValueInCollection("details", 1, "product.description",
        "Arco iris de lágrimas");
    assertValueInCollection("details", 1, "quantity", "1");
    assertValue("remarks", "This is a JUNIT test");
}
</code></pre> </div>
    <div class="wiki" style="display: block;">After searching the created
      invoice we verify whether the values we have saved are there. If the test
      reaches this point your <em>Invoice</em> module works fine. The only
      thing remaining is to delete the created invoice so that the test can be<br>
      executed again. We do that in the <em>remove()</em> method:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="java">private void remove() throws Exception {
    execute("CRUD.delete");
    assertNoErrors();
}
</code></pre> </div>
    <div class="wiki" style="display: block;">It just clicks on “Delete” and
      verifies that no errors are produced.<br>
      <br>
      Congratulations! You have your <em>InvoiceTest</em> completed. Execute
      it, it should be green; if not revise the data in the database, maybe you
      have to add the corresponding products, customer, etc.<br>
      <h2 id="toc17"><a name="Lesson 3: Automated testing-Suite"></a>Suite</h2>
      You have 5 test cases to preserve the quality of your application. When
      you finish some enhancement or fix of your application you must execute
      all your tests to ensure that your already existing functionality is not
      broken.<br>
      Traditionally, to execute all the test for your application you have to
      create a test suite, and execute it. A test suite is a class that
      aggregates all your JUnit tests so you can execute them all at once.
      Fortunately, if you are working with Eclipse you do not need to write a
      test suite class, Eclipse allows you to execute all the test for your
      application automatically:<br>
      <img src="files/testing_en060.png" alt="testing_en060.png" title="testing_en060.png"><br>
      That is, if you execute <em>Run As &gt; JUnit Test</em> on the project
      then all its JUnit tests are executed.<br>
      <h2 id="toc18"><a name="Lesson 3: Automated testing-Summary"></a>Summary</h2>
      You have automated the tests for all the current functionality of your
      application. This test code seems to be more verbose and boring than the
      real application code. But remember, the test code is the most valuable
      asset you have. Right now you may not believe me, but try to do tests and
      once they save your life, you will not develop without test code any more.<br>
      What to test? Don't do an exhaustive test at first. It's better to test a
      little than to test nothing. If you try to do exhaustive testing you will
      end up testing nothing. Start doing a little testing of all your code, and
      with any new feature or fix also write the test for it. In the end, you
      will have a very powerful test suite. Test little but test always.<br>
      In fact, testing is an on going task. In order to preach with the example,
      from now on we'll write all the tests for the code we will develop in the
      rest of the book. Thus you will learn more tips about testing in the next
      lessons.<br>
      <br>
      <strong><a class="wiki_link_ext" href="https://sourceforge.net/projects/openxava/files/openxava-course-source-code/openxava-course-source-code-lesson-3-testing_en.zip/download"

          rel="nofollow">Download source code of this lesson</a></strong><br>
      <br>
      <strong>Any problem with this lesson? <a class="wiki_link_ext" href="http://sourceforge.net/p/openxava/discussion/419690/"

          rel="nofollow">Ask in the forum</a></strong> <strong>Everything fine?
        <a class="wiki_link" href="inheritance_en.html">Go to Lesson 4</a></strong>
    </div>
  </body>
</html>
